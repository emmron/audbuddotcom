---
const currentRoute = Astro.url.pathname;
---

<header class="header">
	<div class="header__wrapper">
		<a href="/" class="header__brand-link" aria-label="Medicinal Cannabis Reviews - Home">
			<h1 class="header__brand-title">Medicinal Cannabis Reviews</h1>
		</a>
		<nav class="header__nav" aria-label="Primary navigation">
			<div class="header__navigation-links" id="navigation-links">
				<a href="/strains" class={`header__nav-link ${currentRoute === '/strains' ? 'header__nav-link--active' : ''}`} aria-current={currentRoute === '/strains' ? 'page' : undefined}>
					<span class="header__nav-icon" aria-hidden="true">üåø</span>
					<span>Strains</span>
				</a>
				<a href="/community" class={`header__nav-link ${currentRoute === '/community' ? 'header__nav-link--active' : ''}`} aria-current={currentRoute === '/community' ? 'page' : undefined}>
					<span class="header__nav-icon" aria-hidden="true">üë•</span>
					<span>Community</span>
				</a>
				<a href="https://cannabisreviews.com/blog" class="header__nav-link" rel="noopener noreferrer" target="_blank">
					<span class="header__nav-icon" aria-hidden="true">üìù</span>
					<span>Blog</span>
				</a>
			</div>
			<div class="header__auth-links" role="navigation" aria-label="User authentication">
				<a href="/signin" class="header__auth-link" aria-label="Sign in to your account">
					<span class="header__auth-icon" aria-hidden="true">üîë</span>
					<span>Sign In</span>
				</a>
				<a href="/signup" class="header__auth-link header__auth-link--highlight" aria-label="Create a new account">
					<span class="header__auth-icon" aria-hidden="true">üìù</span>
					<span>Sign Up</span>
				</a>
			</div>
			<button 
				class="header__menu-toggle" 
				aria-label="Toggle menu" 
				aria-expanded="false" 
				aria-controls="navigation-links"
				aria-haspopup="true"
			>
				<span class="header__toggle-bar"></span>
				<span class="header__toggle-bar"></span>
				<span class="header__toggle-bar"></span>
			</button>
		</nav>
	</div>
</header>

<style>
	.header {
		background: #fff;
		padding: 1rem;
		position: sticky;
		top: 0;
		z-index: 1000;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
		border-bottom: 1px solid rgba(229, 231, 235, 0.8);
	}

	.header__wrapper {
		max-width: var(--content-width);
		margin: 0 auto;
		display: flex;
		justify-content: space-between;
		align-items: center;
		height: 4rem;
		padding: 0 var(--spacing-base);
	}

	.header__brand-link {
		text-decoration: none;
		padding: 0.75rem 1rem;
		border-radius: var(--border-radius);
		transition: background 0.3s ease, transform 0.3s ease;
	}

	.header__brand-link:hover {
		background: rgba(79, 70, 229, 0.08);
		transform: translateY(-1px);
	}

	.header__brand-title {
		margin: 0;
		font-size: 1.625rem;
		font-weight: 800;
		color: #1F2937;
		letter-spacing: -0.03em;
		background: var(--primary-gradient);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
	}

	.header__nav {
		display: flex;
		align-items: center;
		gap: 2.5rem;
	}

	.header__navigation-links {
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.header__nav-link {
		color: #4B5563;
		text-decoration: none;
		font-size: 1.0625rem;
		font-weight: 500;
		padding: 0.875rem 1.25rem;
		border-radius: var(--border-radius);
		transition: background 0.3s ease, transform 0.3s ease, color 0.3s ease;
		display: flex;
		align-items: center;
		gap: 0.625rem;
	}

	.header__nav-link:hover {
		color: #1F2937;
		background: rgba(79, 70, 229, 0.08);
		transform: translateY(-1px);
	}

	.header__nav-icon {
		font-size: 1.375rem;
		opacity: 0.9;
		transition: opacity 0.3s ease, transform 0.3s ease;
	}

	.header__nav-link:hover .header__nav-icon {
		opacity: 1;
		transform: scale(1.1);
	}

	.header__nav-link--active {
		color: #4F46E5 !important;
		background: rgba(79, 70, 229, 0.08);
		font-weight: 600;
	}

	.header__auth-links {
		display: flex;
		gap: 1rem;
		margin-left: 2.5rem;
		padding-left: 2.5rem;
		border-left: 2px solid rgba(229, 231, 235, 0.8);
	}

	.header__auth-link {
		padding: 0.875rem 1.5rem;
		border-radius: var(--border-radius);
		font-weight: 600;
		font-size: 1.0625rem;
		transition: background 0.3s ease, transform 0.3s ease, color 0.3s ease;
	}

	.header__auth-link:not(.header__auth-link--highlight) {
		color: #4B5563;
	}

	.header__auth-link:not(.header__auth-link--highlight):hover {
		color: #1F2937;
		background: rgba(79, 70, 229, 0.08);
		transform: translateY(-1px);
	}

	.header__auth-link--highlight {
		background: var(--primary-gradient);
		color: white;
		box-shadow: var(--card-shadow);
	}

	.header__auth-link--highlight:hover {
		transform: translateY(-2px);
		box-shadow: var(--hover-shadow);
	}

	.header__menu-toggle {
		display: none;
		flex-direction: column;
		gap: 6px;
		padding: 0.875rem;
		background: transparent;
		border: none;
		cursor: pointer;
		border-radius: var(--border-radius);
		transition: background 0.3s ease;
	}

	.header__menu-toggle:hover {
		background: rgba(79, 70, 229, 0.08);
	}

	.header__toggle-bar {
		width: 26px;
		height: 2px;
		background: #4F46E5;
		transition: transform 0.3s ease;
		border-radius: 4px;
	}

	@media (max-width: 1200px) {
		.header__wrapper {
			padding: 0 2rem;
		}
	}

	@media (max-width: 768px) {
		.header__navigation-links,
		.header__auth-links {
			display: none;
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #fff;
			padding: 1.25rem;
			flex-direction: column;
			gap: 0.75rem;
			border-bottom: 1px solid rgba(229, 231, 235, 0.8);
			box-shadow: var(--hover-shadow);
		}

		.header__navigation-links.show,
		.header__auth-links.show {
			display: flex;
		}

		.header__auth-links {
			border: none;
			margin: 0;
			padding: 1.25rem;
			background: #F9FAFB;
		}

		.header__menu-toggle {
			display: flex;
		}

		.header__nav-link,
		.header__auth-link {
			width: 100%;
			justify-content: center;
			padding: 1.125rem;
		}

		.header__auth-link--highlight {
			margin-top: 0.75rem;
		}
	}

	@media (max-width: 480px) {
		.header__wrapper {
			height: 3.75rem;
			padding: 0 1.25rem;
		}
		
		.header__brand-title {
			font-size: 1.375rem;
		}
	}

	@media (prefers-reduced-motion: reduce) {
		* {
			transition: none !important;
		}
	}
</style>
<script>
	type MenuElements = {
		button: HTMLButtonElement | null;
		navLinks: HTMLElement | null;
		authLinks: HTMLElement | null;
		authButtons: HTMLElement | null;
		bars: HTMLElement[];
	};

	type AnimationConfig = {
		readonly open: readonly [string, string, string];
		readonly closed: readonly [string, string, string];
	};

	const ANIMATION = {
		DURATION: 300,
		TIMING: 'cubic-bezier(0.4, 0, 0.2, 1)',
		TRANSFORMS: {
			open: [
				'rotate(45deg) translate(6px, 6px)',
				'scale(0)',
				'rotate(-45deg) translate(6px, -6px)'
			],
			closed: ['none', 'none', 'none']
		} as AnimationConfig
	} as const;

	function initializeMenuElements(): MenuElements {
		try {
			const button = document.querySelector('.menu-toggle') as HTMLButtonElement | null;
			const navLinks = document.querySelector('.navigation-links') as HTMLElement | null;
			const authLinks = document.querySelector('.auth-links') as HTMLElement | null;
			const authButtons = document.querySelector('.auth-links') as HTMLElement | null;
			
			const bars = Array.from(document.querySelectorAll('.toggle-bar')).map((el, index) => {
				if (!(el instanceof HTMLElement)) {
					throw new Error(`Bar element at index ${index} is not HTMLElement`);
				}
				return el;
			});

			if (!button || !navLinks || !authLinks || !authButtons) {
				throw new Error('Required menu elements not found');
			}

			if (bars.length !== 3) {
				throw new Error(`Expected 3 bar elements, found ${bars.length}`);
			}

			return { button, navLinks, authLinks, authButtons, bars };
		} catch (error) {
			console.error('Failed to initialize menu elements:', error instanceof Error ? error.message : 'Unknown error');
			return {
				button: null,
				navLinks: null,
				authLinks: null,
				authButtons: null,
				bars: []
			};
		}
	}

	function animateMenuToggle(elements: MenuElements, isOpen: boolean): void {
		try {
			if (elements.bars.length !== 3) {
				throw new Error('Invalid number of bar elements');
			}

			elements.bars.forEach((bar, index) => {
				if (!bar || !(bar instanceof HTMLElement)) {
					throw new Error(`Invalid bar element at index ${index}`);
				}

				const transition = `transform ${ANIMATION.DURATION}ms ${ANIMATION.TIMING}, opacity ${ANIMATION.DURATION}ms ${ANIMATION.TIMING}`;
				const transform = ANIMATION.TRANSFORMS[isOpen ? 'open' : 'closed'][index];
				const opacity = isOpen && index === 1 ? '0' : '1';

				requestAnimationFrame(() => {
					try {
						bar.style.transition = transition;
						bar.style.transform = transform;
						bar.style.opacity = opacity;
					} catch (err) {
						console.error(`Failed to animate bar ${index}:`, err);
					}
				});
			});
		} catch (error) {
			console.error('Error in menu toggle animation:', error instanceof Error ? error.message : 'Unknown error');
		}
	}

	function announceToScreenReader(message: string): void {
		if (!message || typeof message !== 'string') {
			console.warn('Invalid message for screen reader announcement');
			return;
		}

		try {
			const ariaLive = document.createElement('div');
			ariaLive.setAttribute('aria-live', 'polite');
			ariaLive.setAttribute('aria-atomic', 'true');
			ariaLive.className = 'sr-only';
			ariaLive.textContent = message;
			
			document.body.appendChild(ariaLive);

			const timeoutId = setTimeout(() => {
				if (document.body.contains(ariaLive)) {
					document.body.removeChild(ariaLive);
				}
			}, ANIMATION.DURATION + 700);

			window.addEventListener('beforeunload', () => {
				clearTimeout(timeoutId);
				if (document.body.contains(ariaLive)) {
					document.body.removeChild(ariaLive);
				}
			}, { once: true });

		} catch (error) {
			console.error('Screen reader announcement failed:', error instanceof Error ? error.message : 'Unknown error');
		}
	}

	function handleMenuState(elements: MenuElements, open: boolean): void {
		if (!elements?.button || !elements?.navLinks || !elements?.authLinks || typeof open !== 'boolean') {
			throw new Error('Invalid menu state parameters');
		}

		const { button, navLinks, authLinks } = elements;

		button.setAttribute('aria-expanded', String(open));
		button.setAttribute('aria-label', `${open ? 'Close' : 'Open'} menu`);

		requestAnimationFrame(() => {
			const transition = `opacity ${ANIMATION.DURATION}ms ${ANIMATION.TIMING}, transform ${ANIMATION.DURATION}ms ${ANIMATION.TIMING}`;
			
			[navLinks, authLinks].forEach(element => {
				if (element instanceof HTMLElement) {
					element.style.transition = transition;
					element.classList.toggle('show', open);
				}
			});

			animateMenuToggle(elements, open);

			document.body.style.overflow = open ? 'hidden' : '';
			document.body.classList.toggle('menu-open', open);
		});

		announceToScreenReader(open ? 'Menu opened' : 'Menu closed');
	}

	function initializeMenu(): void {
		const elements = initializeMenuElements();
		if (!elements?.button) {
			throw new Error('Menu initialization failed: button not found');
		}

		let isProcessing = false;
		const DEBOUNCE_TIME = 200;

		function handleClick(e: Event): void {
			if (isProcessing) return;
			
			isProcessing = true;
			e.stopPropagation();

			const isCurrentlyOpen = elements.button?.getAttribute('aria-expanded') === 'true';
			handleMenuState(elements, !isCurrentlyOpen);

			setTimeout(() => { isProcessing = false; }, DEBOUNCE_TIME);
		}

		function handleOutsideClick(e: MouseEvent): void {
			if (isProcessing) return;

			const target = e.target as Node;
			const isMenuOpen = elements.navLinks?.classList.contains('show');
			const menuElements = [elements.button, elements.navLinks, elements.authButtons];
			const isClickInside = menuElements.some(el => el?.contains(target));

			if (isMenuOpen && !isClickInside) {
				handleMenuState(elements, false);
			}
		}

		function handleKeydown(e: KeyboardEvent): void {
			if (e.key === 'Escape' && elements.navLinks?.classList.contains('show')) {
				handleMenuState(elements, false);
			}
		}

		function cleanup(): void {
			document.body.style.overflow = '';
			document.body.classList.remove('menu-open');
			elements.button?.removeEventListener('click', handleClick);
			document.removeEventListener('click', handleOutsideClick);
			document.removeEventListener('keydown', handleKeydown);
		}

		elements.button.addEventListener('click', handleClick);
		document.addEventListener('click', handleOutsideClick);
		document.addEventListener('keydown', handleKeydown);
		window.addEventListener('beforeunload', cleanup, { once: true });

		window.addEventListener('error', (e) => {
			cleanup();
			console.error('Menu system error:', e.error);
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initializeMenu);
	} else {
		initializeMenu();
	}
</script>